package com.tomdignan.android.whoscalling;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.telephony.PhoneStateListener;
import android.telephony.TelephonyManager;
import android.util.Log;

abstract class BaseIncomingCallListener extends BroadcastReceiver {
	private static final String TAG = "WCBaseIncomingCallListener";
	private Context mContext;
	private static boolean sIsRinging = false;
	
	@Override
	public void onReceive(Context context, Intent intent) {
		Log.d(TAG, "onReceive called");
		mContext = context;
		
		String action = intent.getAction();
		Log.d(TAG, "action="+action);
		if (action != null && action.equals(TelephonyManager.ACTION_PHONE_STATE_CHANGED)) {
			handlePhoneStateChange(intent);
		} else {
			Log.w(TAG, "Unknown action sent to " + TAG);
		}
	}
	
	private void handlePhoneStateChange(Intent intent) {
		String state = intent.getStringExtra(TelephonyManager.EXTRA_STATE);
		String phoneNumber = intent.getStringExtra(TelephonyManager.EXTRA_INCOMING_NUMBER);
		if (state.equals(TelephonyManager.EXTRA_STATE_RINGING) && phoneNumber != null) {
			sIsRinging = true;
			onCallReceived(phoneNumber);
		} else if (state.equals(TelephonyManager.EXTRA_STATE_OFFHOOK)) {
			sIsRinging = false;
			onCallAnswered();
		} else if (sIsRinging == true && state.equals(TelephonyManager.EXTRA_STATE_IDLE)) {
			sIsRinging = false;
			onCallHangup();
		}
	
//		Log.d(TelephonyManager.EXTRA_STATE, state);
//		Log.d(TAG, TelephonyManager.EXTRA_STATE_IDLE);
//		Log.d(TAG, TelephonyManager.EXTRA_STATE_OFFHOOK);
//		Log.d(TAG, TelephonyManager.EXTRA_STATE_RINGING);
	}
	
	abstract void onCallReceived(String phoneNumber);
	abstract void onCallAnswered();
	abstract void onCallHangup();
	
	protected Context getContext() {
		return mContext;
	}
}
